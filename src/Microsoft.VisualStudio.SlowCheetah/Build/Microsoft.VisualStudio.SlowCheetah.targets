<?xml version="1.0" encoding="utf-8" ?>
<!--
***********************************************************************************************
SlowCheetah.targets
WARNING:  DO NOT MODIFY this file, this file is added to your project automatically
          through the SlowCheetah NuGet package. If you modify this file it may
          get out of sync when you update the package at a later date.
This file contains the main logic for defining transformations on build.
Copyright (C) Microsoft Corporation. All rights reserved.
Copyright (C) Sayed Ibrahim Hashimi, Chuck England 2011-2013. All rights reserved.
***********************************************************************************************
-->
<Project xmlns="http://schemas.microsoft.com/developer/msbuild/2003">

  <PropertyGroup>
    <SlowCheetahTaskPath>$(MSBuildThisFileDirectory)..\tools\</SlowCheetahTaskPath>
  </PropertyGroup>

  <!--Main transformation task-->
  <UsingTask TaskName="TransformTask" AssemblyFile="$(SlowCheetahTaskPath)Microsoft.VisualStudio.SlowCheetah.dll"/>

  <ItemDefinitionGroup>
    <!-- Default TransformOnBuild values for file types -->
    <None>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
      <CopyToOutputDirectory></CopyToOutputDirectory>
    </None>
    <Content>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
      <CopyToOutputDirectory></CopyToOutputDirectory>
    </Content>
    <Resource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
      <CopyToOutputDirectory></CopyToOutputDirectory>
    </Resource>
    <EmbeddedResource>
      <TransformOnBuild>false</TransformOnBuild>
      <Link></Link>
      <CopyToOutputDirectory></CopyToOutputDirectory>
    </EmbeddedResource>
  </ItemDefinitionGroup>

  <PropertyGroup>
    <BuildDependsOn>
      $(BuildDependsOn);
      ScApplyTransforms;
    </BuildDependsOn>

    <!-- References .dll.config files in referenced projects -->
    <ScAllowCopyReferencedConfig Condition=" '$(ScAllowCopyReferencedConfig)'=='' ">true</ScAllowCopyReferencedConfig>
    <AllowedReferenceRelatedFileExtensions Condition=" '$(ScAllowCopyReferencedConfig)'=='true' ">
      $(AllowedReferenceRelatedFileExtensions);
      .dll.config;
    </AllowedReferenceRelatedFileExtensions>
  
    <BuildDependsOn Condition="'$(ScAllowCopyReferencedConfig)'=='true'">
      $(BuildDependsOn);
      ScUpdateCopiedFilesForReferencingProjects;
    </BuildDependsOn>
  </PropertyGroup>

  <Target Name="ScCollectTransformFiles" BeforeTargets="ScApplyTransforms">

    <Message Text="SlowCheetah: Collecting Transform files" Importance="low"/>

    <ItemGroup>
      <ScFilesToTransform Include="@(None);@(Content);@(Resource);@(EmbeddedResource)"
                         Condition=" '%(TransformOnBuild)' == 'true' ">
        <SourceFile>%(FullPath)</SourceFile>
        <TransformFile>%(RelativeDir)%(Filename).$(Configuration)%(Extension)</TransformFile>
        <DestinationFile>$(OutDir)%(RelativeDir)%(Filename)%(Extension)</DestinationFile>
        <DestinationFile Condition="'%(Link)' != ''">$(OutDir)%(Link)</DestinationFile>
        <Copy>false</Copy>
        <Copy Condition ="'%(CopyToOutputDirectory)' == 'Always' or '%(CopyToOutputDirectory)' == 'PreserveNewest'">true</Copy>
      </ScFilesToTransform>
    </ItemGroup>

  </Target>

  <Target Name="ScApplyTransforms" AfterTargets="CopyFilesToOutputDirectory">

    <Message Text="SlowCheetah: Applying Transforms" Importance="low"/>

    <!-- Get the directories that must be created -->
    <ItemGroup>
      <_ScDirsToCreate Include="@(ScFilesToTransform -> '%(DestinationFile)')" Condition="Exists('%(TransformFile)')"/>
    </ItemGroup>

    <MakeDir Directories="@(_ScDirsToCreate->'%(RelativeDir)')" Condition=" !Exists('%(RelativeDir)') " />

    <SlowCheetah.TransformTask Source="@(ScFilesToTransform->'%(SourceFile)')"
                              Transform="%(TransformFile)"
                              Destination="%(DestinationFile)"
                              Condition="Exists('%(TransformFile)')"/>

  </Target>

  <Target Name ="ScUpdateCopiedFilesForReferencingProjects" AfterTargets="ScApplyTransforms">
    <ItemGroup>
      <AllItemsFullPathWithTargetPath Remove="@(ScFilesToTransform->'%(SourceFile)')" Condition="Exists('%(ScFilesToTransform.DestinationFile)')"/>
      <AllItemsFullPathWithTargetPath Include="@(ScFilesToTransform->'%(DestinationFile)')" Condition="'%(ScFilesToTransform.Copy)' == 'true' and Exists('%(ScFilesToTransform.DestinationFile)')"/>
    </ItemGroup>
  </Target>

  <!-- Import native SlowCheetah behaviour -->
  <Import Project="$(MSBuildThisFileDirectory)Microsoft.VisualStudio.SlowCheetah.*.targets" />

</Project>
